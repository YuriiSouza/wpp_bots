// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  shadowDatabaseUrl = env("DIRECT_URL")
}

model Driver {
  id                           String   @id
  name                         String?
  vehicleType                  String?
  ds                           String?
  noShowCount                  Int      @default(0)
  declineRate                  Float    @default(0)
  priorityScore                Float    @default(0)
  updatedAt                    DateTime @updatedAt
  createdAt                    DateTime @default(now())

  routes                        Route[] @relation("RouteDriver")
}

model ConversationState {
  phone          String   @id
  step           String   // "ASK_DRIVER_ID" | "DONE"
  lastDriverId   String?
  updatedAt      DateTime @updatedAt
  createdAt      DateTime @default(now())
}

model Route {
  id                        String      @id
  gaiola                    String?
  bairro                    String?
  cidade                    String?
  requiredVehicleType       String?
  requiredVehicleTypeNorm   String?
  suggestionDriverDs        String?
  km                        String?
  spr                       String?
  volume                    String?
  gg                        String?
  veiculoRoterizado         String?
  driverId                  String?
  driverName                String?
  driverVehicleType         String?
  driverAccuracy            String?
  driverPlate               String?
  status                    RouteStatus @default(DISPONIVEL)
  assignedAt                DateTime?
  updatedAt                 DateTime    @updatedAt
  createdAt                 DateTime    @default(now())

  driver                    Driver?     @relation("RouteDriver", fields: [driverId], references: [id])
}

model SyncLog {
  id               String   @id @default(uuid())
  status           String
  startedAt        DateTime @default(now())
  finishedAt       DateTime?
  driversCount     Int      @default(0)
  routesAvailable  Int      @default(0)
  routesAssigned   Int      @default(0)
  message          String?
}

model AssignmentOverview {
  id         String   @id @default(uuid())
  rowNumber  Int      @unique
  driverId   String?
  payload    Json
  updatedAt  DateTime @updatedAt
  createdAt  DateTime @default(now())

  @@index([driverId])
}

model DriverBlacklist {
  driverId           String          @id
  status             BlacklistStatus @default(ACTIVE)
  timesListed        Int             @default(1)
  lastActivatedAt    DateTime?
  lastInactivatedAt  DateTime?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  @@index([status])
  @@index([updatedAt])
}

model FaqItem {
  id        String   @id @default(uuid())
  title     String
  answer    String
  position  Int      @default(0)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([active, position])
}

enum RouteStatus {
  DISPONIVEL
  ATRIBUIDA
  BLOQUEADA
}

enum BlacklistStatus {
  ACTIVE
  INACTIVE
}
